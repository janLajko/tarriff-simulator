表一：s301_measures（测度/税率）

作用：承载 9903.88.xx 对某国的税率与计征口径，可随时间变更。

CREATE TABLE s301_measures (
  id BIGSERIAL PRIMARY KEY,
  heading TEXT NOT NULL,                       -- 例如 '9903.88.01'
  country_iso2 TEXT NOT NULL,                  -- 例如 'CN'
  ad_valorem_rate NUMERIC(6,3) NOT NULL,       -- ad valorem 百分比，25% 记 25.000
  value_basis TEXT NOT NULL,                   -- 计征口径，如 'customs_value' 或 'increment_9802'
  notes JSONB,                                 -- 补充口径，如 98章特殊算法
  effective_start_date DATE NOT NULL,          -- 税率生效起
  effective_end_date DATE,                     -- 税率生效止，NULL 表示仍有效
  UNIQUE(heading, country_iso2, effective_start_date, COALESCE(effective_end_date,'9999-12-31'))
);
CREATE INDEX idx_measures_heading_country_date
  ON s301_measures(heading, country_iso2, effective_start_date, effective_end_date);

--说明
heading：9903.88.01/02/50/…

value_basis：计税基准；常规 301 用 customs_value。9802 情形可设置 increment_9802。

effective_*：允许后续调整税率而不覆盖历史。

表二：s301_scope（候选范围）

作用：声明“哪些 HTS 可能受某些测度作用”。只定义集合本身与其时间窗，不绑定具体测度
CREATE TABLE s301_scope (
  id BIGSERIAL PRIMARY KEY,
  key TEXT NOT NULL,                           -- 例如 '8501.10.40' 或 'note20(b)'
  key_type TEXT NOT NULL CHECK (key_type IN ('hts8','heading','note')),
  country_iso2 TEXT,                           -- 可选；为空表示不限定国家
  source_label TEXT,                            -- 如 'note20(b)'、'compiler:seed'
  effective_start_date DATE NOT NULL,          -- 范围生效起
  effective_end_date DATE,                     -- 范围生效止
  UNIQUE(key, key_type, COALESCE(country_iso2,''), effective_start_date, COALESCE(effective_end_date,'9999-12-31'))
);
CREATE INDEX idx_scope_key ON s301_scope(key, key_type);
CREATE INDEX idx_scope_dates ON s301_scope(effective_start_date, effective_end_date);

--说明

key+key_type：既支持按 HTS8，也支持未来用某个 HTS heading 或 note 代表的集合。

country_iso2：如仅对 CN 有意义可填写 'CN'；否则置空。

表三：s301_scope_measure_map（范围↔测度关系）

作用：把某个 scope 与某个 measure 按时间建立“包含/排除”的关系。
CREATE TABLE s301_scope_measure_map (
  id BIGSERIAL PRIMARY KEY,
  scope_id BIGINT NOT NULL REFERENCES s301_scope(id) ON DELETE CASCADE,
  measure_id BIGINT NOT NULL REFERENCES s301_measures(id) ON DELETE CASCADE,
  relation TEXT NOT NULL CHECK (relation IN ('include','exclude')),
  note_label TEXT,                              -- 如 '20(h)'，可空
  text_criteria TEXT,                           -- 原文条件或备注
  effective_start_date DATE NOT NULL,           -- 关系生效起（可与 scope 不同）
  effective_end_date DATE,                      -- 关系生效止
  UNIQUE(scope_id, measure_id, relation, effective_start_date, COALESCE(effective_end_date,'9999-12-31'))
);
CREATE INDEX idx_map_scope ON s301_scope_measure_map(scope_id);
CREATE INDEX idx_map_measure ON s301_scope_measure_map(measure_id, relation);
CREATE INDEX idx_map_dates ON s301_scope_measure_map(effective_start_date, effective_end_date);

--说明
时间窗放在关系层，解决“范围不变但排除/包含窗口变化”的常见情况。

如需表达“排除仅限某 HTS 子集”，用多个 scope 记录分别映射。

--example

INSERT INTO s301_measures
(heading, country_iso2, ad_valorem_rate, value_basis, notes, effective_start_date, effective_end_date)
VALUES
('9903.88.01','CN',25.000,'customs_value','{"chapter98_exception":true}'::jsonb,'2018-07-06',NULL);
-- 假设生成 measure_id = 1

INSERT INTO s301_scope
(key, key_type, country_iso2, source_label, effective_start_date, effective_end_date)
VALUES
('8501.10.40','hts8','CN','note20(b)','2018-07-06',NULL),    -- id=1
('8501.10.60','hts8','CN','note20(b)','2018-07-06',NULL);    -- id=2


INSERT INTO s301_scope_measure_map
(scope_id, measure_id, relation, note_label, text_criteria, effective_start_date, effective_end_date)
VALUES
(1, 1, 'include', '20(b)', NULL, '2018-07-06', NULL),
(2, 1, 'include', '20(b)', NULL, '2018-07-06', NULL);


-- 仍旧使用同一个 scope 记录（id=1），增加一条“排除”关系，覆盖时间窗
INSERT INTO s301_scope_measure_map
(scope_id, measure_id, relation, note_label, text_criteria, effective_start_date, effective_end_date)
VALUES
(1, 1, 'exclude', '20(ccc)', '排除窗口示例', '2020-01-01', '2020-12-31');


versionv2
CREATE TABLE s301_measures(
  id BIGSERIAL PRIMARY KEY,
  heading TEXT NOT NULL,                       -- 例如 '9903.88.01'
  country_iso2 TEXT NOT NULL,                  -- 例如 'CN'
  ad_valorem_rate NUMERIC(6,3) NOT NULL,       -- ad valorem 百分比，25% 记 25.000
  value_basis TEXT NOT NULL,                   -- 计征口径，如 'customs_value' 或 'increment_9802'
  notes JSONB,                                 -- 补充口径，如 98章特殊算法
  effective_start_date DATE NOT NULL,          -- 税率生效起
  effective_end_date DATE                      -- 税率生效止，NULL 表示仍有效
);

-- 用唯一索引代替 UNIQUE 约束
CREATE UNIQUE INDEX idx_measures_unique 
  ON s301_measures(heading, country_iso2, effective_start_date, COALESCE(effective_end_date, '9999-12-31'));

CREATE INDEX idx_measures_heading_country_date
  ON s301_measures(heading, country_iso2, effective_start_date, effective_end_date);

CREATE TABLE s301_scope (
  id BIGSERIAL PRIMARY KEY,
  key TEXT NOT NULL,                           -- 例如 '8501.10.40' 或 'note20(b)'
  key_type TEXT NOT NULL CHECK (key_type IN ('hts8','heading','note')),
  country_iso2 TEXT,                           -- 可选；为空表示不限定国家
  source_label TEXT,                           -- 如 'note20(b)'、'compiler:seed'
  effective_start_date DATE NOT NULL,          -- 范围生效起
  effective_end_date DATE                      -- 范围生效止
);

-- 用唯一索引代替 UNIQUE 约束
CREATE UNIQUE INDEX idx_scope_unique 
  ON s301_scope(key, key_type, COALESCE(country_iso2, ''), effective_start_date, COALESCE(effective_end_date, '9999-12-31'));

CREATE INDEX idx_scope_key ON s301_scope(key, key_type);
CREATE INDEX idx_scope_dates ON s301_scope(effective_start_date, effective_end_date);

CREATE TABLE s301_scope_measure_map (
  id BIGSERIAL PRIMARY KEY,
  scope_id BIGINT NOT NULL REFERENCES s301_scope(id) ON DELETE CASCADE,
  measure_id BIGINT NOT NULL REFERENCES s301_measures(id) ON DELETE CASCADE,
  relation TEXT NOT NULL CHECK (relation IN ('include','exclude')),
  note_label TEXT,                              -- 如 '20(h)'，可空
  text_criteria TEXT,                           -- 原文条件或备注
  effective_start_date DATE NOT NULL,           -- 关系生效起（可与 scope 不同）
  effective_end_date DATE                       -- 关系生效止
);

-- 用唯一索引代替 UNIQUE 约束
CREATE UNIQUE INDEX idx_map_unique 
  ON s301_scope_measure_map(scope_id, measure_id, relation, effective_start_date, COALESCE(effective_end_date, '9999-12-31'));

CREATE INDEX idx_map_scope ON s301_scope_measure_map(scope_id);
CREATE INDEX idx_map_measure ON s301_scope_measure_map(measure_id, relation);
CREATE INDEX idx_map_dates ON s301_scope_measure_map(effective_start_date, effective_end_date);
